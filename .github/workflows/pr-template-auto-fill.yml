name: PR Template Auto Fill

on:
  pull_request:
    types: [opened]

permissions:
  pull-requests: write
  contents: read

jobs:
  auto-fill-pr-template:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Auto-fill PR template with commit issues
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const prNumber = context.payload.pull_request.number;
            const prBody = context.payload.pull_request.body || '';
            const baseBranch = context.payload.pull_request.base.ref;
            const headBranch = context.payload.pull_request.head.ref;

            // ì´ë¯¸ ì´ìŠˆ ë²ˆí˜¸ê°€ ì±„ì›Œì ¸ ìˆëŠ”ì§€ í™•ì¸ (ì—¬ëŸ¬ íŒ¨í„´ ì§€ì›)
            const hasIssueAlready = /(?:### ì—°ê´€ëœ ì´ìŠˆ|## ğŸ”— ì—°ê´€ëœ ì´ìŠˆ)\s*\n\n(?!<!--)/.test(prBody);

            if (hasIssueAlready) {
              console.log('PR template already has issue numbers filled');
              return;
            }

            try {
              // ë¸Œëœì¹˜ ì´ë¦„ì—ì„œ ì´ìŠˆ ë²ˆí˜¸ ì¶”ì¶œ (ë‹¤ì–‘í•œ íŒ¨í„´ ì§€ì›)
              const branchIssuePatterns = [
                /feature-(\d+)/gi,           // feature-18/pr_issue_link
                /feature\/(\d+)/gi,          // feature/18-description
                /bugfix-(\d+)/gi,            // bugfix-123/fix-error
                /bugfix\/(\d+)/gi,           // bugfix/123-fix-error
                /hotfix-(\d+)/gi,            // hotfix-456/urgent-fix
                /hotfix\/(\d+)/gi,           // hotfix/456-urgent-fix
                /(\d+)/g                     // ëª¨ë“  ìˆ«ì íŒ¨í„´
              ];
              
              let branchIssueNumbers = new Set();
              branchIssuePatterns.forEach(pattern => {
                const matches = [...headBranch.matchAll(pattern)];
                matches.forEach(match => {
                  if (match[1] && !isNaN(match[1])) {
                    branchIssueNumbers.add(match[1]);
                  }
                });
              });
              
              // ì»¤ë°‹ ë©”ì‹œì§€ì—ì„œ ì´ìŠˆ ë²ˆí˜¸ ì¶”ì¶œ
              const { data: commits } = await github.rest.pulls.listCommits({
                owner,
                repo,
                pull_number: prNumber
              });

              let allIssueNumbers = new Set();
              
              // ë¸Œëœì¹˜ ì´ë¦„ì—ì„œ ì´ìŠˆ ë²ˆí˜¸ ì¶”ê°€
              branchIssueNumbers.forEach(num => allIssueNumbers.add(num));

              // ì»¤ë°‹ ë©”ì‹œì§€ì—ì„œ ì´ìŠˆ ë²ˆí˜¸ ì¶”ì¶œ
              commits.forEach(commit => {
                const message = commit.commit.message;
                const issuePatterns = [
                  /#(\d+)/g,
                  /ì´ìŠˆ\s*#?(\d+)/gi,
                  /issue\s*#?(\d+)/gi,
                  /(close[sd]?|fix(e[sd])?|resolve[sd]?)\s+#(\d+)/gi
                ];

                issuePatterns.forEach(pattern => {
                  const matches = [...message.matchAll(pattern)];
                  matches.forEach(match => {
                    const issueNumber = match[match.length - 1];
                    if (issueNumber && !isNaN(issueNumber)) {
                      allIssueNumbers.add(issueNumber);
                    }
                  });
                });
              });

              if (allIssueNumbers.size > 0) {
                const issueList = Array.from(allIssueNumbers);
                
                // ì‹¤ì œ ì¡´ì¬í•˜ëŠ” ì´ìŠˆì¸ì§€ í™•ì¸
                const validIssues = [];
                for (const issueNumber of issueList) {
                  try {
                    await github.rest.issues.get({
                      owner,
                      repo,
                      issue_number: issueNumber
                    });
                    validIssues.push(issueNumber);
                  } catch (error) {
                    if (error.status === 404) {
                      console.log(`Issue #${issueNumber} not found, skipping`);
                    }
                  }
                }

                if (validIssues.length > 0) {
                  // ì´ìŠˆ ë²ˆí˜¸ë“¤ì„ Closes í˜•íƒœë¡œ í¬ë§·íŒ…
                  const issueLinks = validIssues.map(num => `Closes #${num}`).join(', ');
                  
                  // PR ë³¸ë¬¸ì—ì„œ ì—°ê´€ëœ ì´ìŠˆ ì„¹ì…˜ ì°¾ì•„ì„œ êµì²´ (ì—¬ëŸ¬ íŒ¨í„´ ì§€ì›)
                  const patterns = [
                    /(### ì—°ê´€ëœ ì´ìŠˆ\s*\n+)<!-- ì´ìŠˆ ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”[\.\s]*ì˜ˆ: Closes #123, Fixes #456, Resolves #789 -->[\s\S]*?(?=\n##|\n###|$)/,
                    /(## ğŸ”— ì—°ê´€ëœ ì´ìŠˆ\s*\n+)<!-- ì´ìŠˆ ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”[\.\s]*ì˜ˆ: Closes #123, Fixes #456, Resolves #789 -->[\s\S]*?(?=\n##|\n###|$)/
                  ];
                  
                  let updatedBody = prBody;
                  let wasUpdated = false;
                  
                  for (const pattern of patterns) {
                    const newBody = updatedBody.replace(pattern, `$1${issueLinks}\n`);
                    if (newBody !== updatedBody) {
                      updatedBody = newBody;
                      wasUpdated = true;
                      break;
                    }
                  }

                  if (wasUpdated) {
                    await github.rest.pulls.update({
                      owner,
                      repo,
                      pull_number: prNumber,
                      body: updatedBody
                    });
                    
                    console.log(`Auto-filled PR template with issues: ${issueLinks}`);
                    console.log(`Branch: ${headBranch}, Detected issues from branch: ${Array.from(branchIssueNumbers).join(', ')}`);
                    
                    // PRì— ì½”ë©˜íŠ¸ ì¶”ê°€
                    await github.rest.issues.createComment({
                      owner,
                      repo,
                      issue_number: prNumber,
                      body: `ğŸ¤– **ìë™ ê°ì§€ëœ ì—°ê´€ ì´ìŠˆë“¤ì´ PR í…œí”Œë¦¿ì— ìë™ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤**\n\n` +
                            `**ê°ì§€ëœ ì´ìŠˆ:** ${validIssues.map(num => `#${num}`).join(', ')}\n\n` +
                            `**ë¸Œëœì¹˜ëª…:** \`${headBranch}\`\n\n` +
                            `ë¸Œëœì¹˜ëª…ê³¼ ì»¤ë°‹ ë©”ì‹œì§€ë¥¼ ë¶„ì„í•˜ì—¬ ìë™ìœ¼ë¡œ ì—°ê²°í–ˆìŠµë‹ˆë‹¤. ìˆ˜ì •ì´ í•„ìš”í•˜ì‹œë©´ PR ì„¤ëª…ì„ ì§ì ‘ í¸ì§‘í•´ì£¼ì„¸ìš”.`
                    });
                  } else {
                    console.log('Failed to update PR template - pattern not found');
                    console.log(`Branch: ${headBranch}, PR Body preview: ${prBody.substring(0, 200)}`);
                  }
                } else {
                  console.log('No valid issues found');
                  console.log(`Branch: ${headBranch}, Found numbers: ${Array.from(allIssueNumbers).join(', ')}`);
                }
              } else {
                console.log('No issue numbers found in branch name or commit messages');
                console.log(`Branch: ${headBranch}, Branch numbers: ${Array.from(branchIssueNumbers).join(', ')}`);
              }
              
            } catch (error) {
              console.error('Error auto-filling PR template:', error);
            }
