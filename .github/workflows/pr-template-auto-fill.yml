name: PR í…œí”Œë¦¿ ìë™ ì™„ì„±

on:
  pull_request:
    types: [opened]

permissions:
  pull-requests: write
  contents: read

jobs:
  auto-fill-pr-template:
    name: PR í…œí”Œë¦¿ ìë™ ì™„ì„± ì‘ì—…
    runs-on: ubuntu-latest
    steps:
      - name: ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ë¸Œëœì¹˜ëª…ì—ì„œ ì´ìŠˆ ë²ˆí˜¸ ì¶”ì¶œ
        id: extract-branch
        uses: ./.github/actions/extract-issue-numbers
        with:
          text: ${{ github.event.pull_request.head.ref }}
          source-type: 'branch-name'
          validate-issues: true

      - name: ì»¤ë°‹ ë©”ì‹œì§€ì—ì„œ ì´ìŠˆ ë²ˆí˜¸ ì¶”ì¶œ
        id: extract-commits
        uses: ./.github/actions/extract-issue-numbers
        with:
          text: commits
          source-type: 'commit-messages'
          pr-number: ${{ github.event.pull_request.number }}
          validate-issues: true

      - name: PR í…œí”Œë¦¿ ìë™ ì™„ì„± ì‹¤í–‰
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const prNumber = context.payload.pull_request.number;
            const prBody = context.payload.pull_request.body || '';
            const headBranch = context.payload.pull_request.head.ref;

            // ì´ë¯¸ ì´ìŠˆ ë²ˆí˜¸ê°€ ì±„ì›Œì ¸ ìˆëŠ”ì§€ í™•ì¸ (ì—¬ëŸ¬ íŒ¨í„´ ì§€ì›)
            const hasIssueAlready = /(?:### ì—°ê´€ëœ ì´ìŠˆ|## ğŸ”— ì—°ê´€ëœ ì´ìŠˆ)\s*\n\n(?!<!--)/.test(prBody);

            if (hasIssueAlready) {
              console.log('PR template already has issue numbers filled');
              return;
            }

            try {
              // ë¸Œëœì¹˜ì™€ ì»¤ë°‹ì—ì„œ ì¶”ì¶œí•œ ì´ìŠˆ ë²ˆí˜¸ë“¤ í•©ì¹˜ê¸°
              const branchIssues = '${{ steps.extract-branch.outputs.valid-issues }}'.split(',').filter(n => n);
              const commitIssues = '${{ steps.extract-commits.outputs.valid-issues }}'.split(',').filter(n => n);
              
              // ì¤‘ë³µ ì œê±°í•˜ì—¬ ëª¨ë“  ì´ìŠˆ ë²ˆí˜¸ í•©ì¹˜ê¸°
              const allValidIssues = [...new Set([...branchIssues, ...commitIssues])];

              if (allValidIssues.length > 0) {
                // ì´ìŠˆ ë²ˆí˜¸ë“¤ì„ Closes í˜•íƒœë¡œ í¬ë§·íŒ…
                const issueLinks = allValidIssues.map(num => `Closes #${num}`).join(', ');
                
                // PR ë³¸ë¬¸ì—ì„œ ì—°ê´€ëœ ì´ìŠˆ ì„¹ì…˜ ì°¾ì•„ì„œ êµì²´ (ì—¬ëŸ¬ íŒ¨í„´ ì§€ì›)
                const patterns = [
                  /(### ì—°ê´€ëœ ì´ìŠˆ\s*\n+)<!-- ì´ìŠˆ ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”[\.\s]*ì˜ˆ: Closes #123, Fixes #456, Resolves #789 -->[\s\S]*?(?=\n##|\n###|$)/,
                  /(## ğŸ”— ì—°ê´€ëœ ì´ìŠˆ\s*\n+)<!-- ì´ìŠˆ ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”[\.\s]*ì˜ˆ: Closes #123, Fixes #456, Resolves #789 -->[\s\S]*?(?=\n##|\n###|$)/
                ];
                
                let updatedBody = prBody;
                let wasUpdated = false;
                
                for (const pattern of patterns) {
                  const newBody = updatedBody.replace(pattern, `$1${issueLinks}\n`);
                  if (newBody !== updatedBody) {
                    updatedBody = newBody;
                    wasUpdated = true;
                    break;
                  }
                }

                if (wasUpdated) {
                  await github.rest.pulls.update({
                    owner,
                    repo,
                    pull_number: prNumber,
                    body: updatedBody
                  });
                  
                  console.log(`Auto-filled PR template with issues: ${issueLinks}`);
                  console.log(`Branch: ${headBranch}, Branch issues: ${branchIssues.join(', ')}, Commit issues: ${commitIssues.join(', ')}`);
                  
                  // PRì— ì½”ë©˜íŠ¸ ì¶”ê°€
                  await github.rest.issues.createComment({
                    owner,
                    repo,
                    issue_number: prNumber,
                    body: `ğŸ¤– **ìë™ ê°ì§€ëœ ì—°ê´€ ì´ìŠˆë“¤ì´ PR í…œí”Œë¦¿ì— ìë™ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤**\n\n` +
                          `**ê°ì§€ëœ ì´ìŠˆ:** ${allValidIssues.map(num => `#${num}`).join(', ')}\n\n` +
                          `**ë¸Œëœì¹˜ëª…:** \`${headBranch}\`\n\n` +
                          `ë¸Œëœì¹˜ëª…ê³¼ ì»¤ë°‹ ë©”ì‹œì§€ë¥¼ ë¶„ì„í•˜ì—¬ ìë™ìœ¼ë¡œ ì—°ê²°í–ˆìŠµë‹ˆë‹¤. ìˆ˜ì •ì´ í•„ìš”í•˜ì‹œë©´ PR ì„¤ëª…ì„ ì§ì ‘ í¸ì§‘í•´ì£¼ì„¸ìš”.`
                  });
                } else {
                  console.log('Failed to update PR template - pattern not found');
                  console.log(`Branch: ${headBranch}, PR Body preview: ${prBody.substring(0, 200)}`);
                }
              } else {
                console.log('No valid issues found');
                console.log(`Branch: ${headBranch}`);
              }
              
            } catch (error) {
              console.error('Error auto-filling PR template:', error);
            }
