name: Issue Management

on:
  pull_request:
    types: [opened, closed, reopened]
    branches:
      - main
      - develop
  create:
    # ë¸Œëœì¹˜ê°€ ìƒì„±ë  ë•Œ
  push:
    branches:
      - '**'
    paths-ignore:
      - 'main'
      - 'develop'

permissions:
  issues: write
  pull-requests: write
  contents: read

jobs:
  # PRì´ ìƒì„±ë˜ê±°ë‚˜ ë¸Œëœì¹˜ê°€ ìƒì„±ë  ë•Œ in-progress ë¼ë²¨ ì¶”ê°€ ë° ë‹´ë‹¹ì ì§€ì •
  handle-pr-opened:
    if: github.event_name == 'pull_request' && github.event.action == 'opened'
    runs-on: ubuntu-latest
    steps:
      - name: Add in-progress label to linked issues
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const prBody = context.payload.pull_request.body || '';
            const prAuthor = context.payload.pull_request.user.login;

            // PR ë³¸ë¬¸ì—ì„œ ì´ìŠˆ ë²ˆí˜¸ ì¶”ì¶œ (closes #123, fixes #456, resolves #789 ë“±)
            // ë‹¤ì–‘í•œ íŒ¨í„´ì„ ì§€ì›: "Closes #123", "fixes #456", "resolve #789", "#123" ë“±
            const issuePatterns = [
              /(close[sd]?|fix(e[sd])?|resolve[sd]?)\s+#(\d+)/gi,
              /(?:^|\s)#(\d+)(?:\s|$)/g,
              /ì´ìŠˆ\s*#?(\d+)/gi,
              /issue\s*#?(\d+)/gi
            ];

            let allIssueNumbers = new Set();

            for (const pattern of issuePatterns) {
              const matches = [...prBody.matchAll(pattern)];
              matches.forEach(match => {
                const issueNumber = match[match.length - 1]; // ë§ˆì§€ë§‰ ìº¡ì²˜ ê·¸ë£¹ì´ ì´ìŠˆ ë²ˆí˜¸
                if (issueNumber && !isNaN(issueNumber)) {
                  allIssueNumbers.add(issueNumber);
                }
              });
            }

            const issueMatches = allIssueNumbers.size > 0 ? Array.from(allIssueNumbers) : null;

            if (issueMatches && issueMatches.length > 0) {
              for (const issueNumber of issueMatches) {
                
                try {
                  // ì´ìŠˆì— in-progress ë¼ë²¨ ì¶”ê°€
                  await github.rest.issues.addLabels({
                    owner,
                    repo,
                    issue_number: issueNumber,
                    labels: ['in-progress']
                  });
                  
                  // ì´ìŠˆì— PR ì‘ì„±ìë¥¼ ë‹´ë‹¹ìë¡œ ì§€ì •
                  await github.rest.issues.addAssignees({
                    owner,
                    repo,
                    issue_number: issueNumber,
                    assignees: [prAuthor]
                  });
                  
                  console.log(`Added in-progress label and assigned ${prAuthor} to issue #${issueNumber}`);
                } catch (error) {
                  console.log(`Failed to update issue #${issueNumber}: ${error.message}`);
                }
              }
            } else {
              console.log('No linked issues found in PR body');
            }

  # ë¸Œëœì¹˜ ìƒì„± ì‹œ ê´€ë ¨ ì´ìŠˆì— ë¼ë²¨ ì¶”ê°€
  handle-branch-created:
    if: github.event_name == 'create' && github.event.ref_type == 'branch'
    runs-on: ubuntu-latest
    steps:
      - name: Add in-progress label to related issues
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const branchName = context.payload.ref;
            const branchAuthor = context.payload.sender.login;

            // ë¸Œëœì¹˜ ì´ë¦„ì—ì„œ ì´ìŠˆ ë²ˆí˜¸ ì¶”ì¶œ (feature/123-description, bugfix/456-fix ë“±)
            const issueMatches = branchName.match(/(\d+)/g);

            if (issueMatches) {
              for (const issueNumber of issueMatches) {
                try {
                  // ì´ìŠˆê°€ ì‹¤ì œë¡œ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
                  const issue = await github.rest.issues.get({
                    owner,
                    repo,
                    issue_number: issueNumber
                  });
                  
                  // ì´ìŠˆì— in-progress ë¼ë²¨ ì¶”ê°€
                  await github.rest.issues.addLabels({
                    owner,
                    repo,
                    issue_number: issueNumber,
                    labels: ['in-progress']
                  });
                  
                  // ë¸Œëœì¹˜ ìƒì„±ìë¥¼ ë‹´ë‹¹ìë¡œ ì§€ì •
                  await github.rest.issues.addAssignees({
                    owner,
                    repo,
                    issue_number: issueNumber,
                    assignees: [branchAuthor]
                  });
                  
                  console.log(`Added in-progress label and assigned ${branchAuthor} to issue #${issueNumber} for branch ${branchName}`);
                } catch (error) {
                  if (error.status === 404) {
                    console.log(`Issue #${issueNumber} not found`);
                  } else {
                    console.log(`Failed to update issue #${issueNumber}: ${error.message}`);
                  }
                }
              }
            } else {
              console.log(`No issue numbers found in branch name: ${branchName}`);
            }

  # PRì´ ë¨¸ì§€ë  ë•Œ ì—°ê²°ëœ ì´ìŠˆ ìë™ ë‹«ê¸°
  close-linked-issues:
    if: github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Close linked issues
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const prBody = context.payload.pull_request.body || '';
            const prNumber = context.payload.pull_request.number;
            const prTitle = context.payload.pull_request.title;

            // PR ë³¸ë¬¸ì—ì„œ ì´ìŠˆ ë²ˆí˜¸ ì¶”ì¶œ
            const issuePatterns = [
              /(close[sd]?|fix(e[sd])?|resolve[sd]?)\s+#(\d+)/gi,
              /(?:^|\s)#(\d+)(?:\s|$)/g,
              /ì´ìŠˆ\s*#?(\d+)/gi,
              /issue\s*#?(\d+)/gi
            ];

            let allIssueNumbers = new Set();

            for (const pattern of issuePatterns) {
              const matches = [...prBody.matchAll(pattern)];
              matches.forEach(match => {
                const issueNumber = match[match.length - 1];
                if (issueNumber && !isNaN(issueNumber)) {
                  allIssueNumbers.add(issueNumber);
                }
              });
            }

            const issueMatches = allIssueNumbers.size > 0 ? Array.from(allIssueNumbers) : null;

            if (issueMatches && issueMatches.length > 0) {
              for (const issueNumber of issueMatches) {
                
                try {
                  // ì´ìŠˆ ë‹«ê¸°
                  await github.rest.issues.update({
                    owner,
                    repo,
                    issue_number: issueNumber,
                    state: 'closed'
                  });
                  
                  // ì´ìŠˆì— ì™„ë£Œ ì½”ë©˜íŠ¸ ì¶”ê°€
                  await github.rest.issues.createComment({
                    owner,
                    repo,
                    issue_number: issueNumber,
                    body: `âœ… ì´ ì´ìŠˆëŠ” PR #${prNumber}ì´ ë¨¸ì§€ë˜ì–´ ìë™ìœ¼ë¡œ ë‹«í˜”ìŠµë‹ˆë‹¤.\n\n**PR ì œëª©:** ${prTitle}`
                  });
                  
                  // in-progress ë¼ë²¨ ì œê±°í•˜ê³  completed ë¼ë²¨ ì¶”ê°€
                  try {
                    await github.rest.issues.removeLabel({
                      owner,
                      repo,
                      issue_number: issueNumber,
                      name: 'in-progress'
                    });
                  } catch (error) {
                    console.log(`in-progress label not found on issue #${issueNumber}`);
                  }
                  
                  await github.rest.issues.addLabels({
                    owner,
                    repo,
                    issue_number: issueNumber,
                    labels: ['completed']
                  });
                  
                  console.log(`Closed issue #${issueNumber} and updated labels`);
                } catch (error) {
                  console.log(`Failed to close issue #${issueNumber}: ${error.message}`);
                }
              }
            } else {
              console.log('No linked issues found in PR body');
            }

  # PRì´ ë‹¤ì‹œ ì—´ë¦´ ë•Œ ì´ìŠˆë„ ë‹¤ì‹œ ì—´ê¸°
  reopen-linked-issues:
    if: github.event_name == 'pull_request' && github.event.action == 'reopened'
    runs-on: ubuntu-latest
    steps:
      - name: Reopen linked issues
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const prBody = context.payload.pull_request.body || '';
            const prNumber = context.payload.pull_request.number;

            const issuePatterns = [
              /(close[sd]?|fix(e[sd])?|resolve[sd]?)\s+#(\d+)/gi,
              /(?:^|\s)#(\d+)(?:\s|$)/g,
              /ì´ìŠˆ\s*#?(\d+)/gi,
              /issue\s*#?(\d+)/gi
            ];

            let allIssueNumbers = new Set();

            for (const pattern of issuePatterns) {
              const matches = [...prBody.matchAll(pattern)];
              matches.forEach(match => {
                const issueNumber = match[match.length - 1];
                if (issueNumber && !isNaN(issueNumber)) {
                  allIssueNumbers.add(issueNumber);
                }
              });
            }

            const issueMatches = allIssueNumbers.size > 0 ? Array.from(allIssueNumbers) : null;

            if (issueMatches && issueMatches.length > 0) {
              for (const issueNumber of issueMatches) {
                
                try {
                  await github.rest.issues.update({
                    owner,
                    repo,
                    issue_number: issueNumber,
                    state: 'open'
                  });
                  
                  // completed ë¼ë²¨ ì œê±°í•˜ê³  in-progress ë¼ë²¨ ì¶”ê°€
                  try {
                    await github.rest.issues.removeLabel({
                      owner,
                      repo,
                      issue_number: issueNumber,
                      name: 'completed'
                    });
                  } catch (error) {
                    console.log(`completed label not found on issue #${issueNumber}`);
                  }
                  
                  await github.rest.issues.addLabels({
                    owner,
                    repo,
                    issue_number: issueNumber,
                    labels: ['in-progress']
                  });
                  
                  await github.rest.issues.createComment({
                    owner,
                    repo,
                    issue_number: issueNumber,
                    body: `ğŸ”„ ì´ ì´ìŠˆëŠ” PR #${prNumber}ì´ ë‹¤ì‹œ ì—´ë ¤ì„œ ì¬ê°œë˜ì—ˆìŠµë‹ˆë‹¤.`
                  });
                  
                  console.log(`Reopened issue #${issueNumber}`);
                } catch (error) {
                  console.log(`Failed to reopen issue #${issueNumber}: ${error.message}`);
                }
              }
            }
