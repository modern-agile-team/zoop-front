name: Issue Management

on:
  pull_request:
    types: [opened, closed, reopened]
    branches:
      - main
      - develop
  create:
    # ë¸Œëœì¹˜ê°€ ìƒì„±ë  ë•Œ
  push:
    branches:
      - '**'
    paths-ignore:
      - 'main'
      - 'develop'

permissions:
  issues: write
  pull-requests: write
  contents: read

jobs:
  # PRì´ ìƒì„±ë˜ê±°ë‚˜ ë¸Œëœì¹˜ê°€ ìƒì„±ë  ë•Œ in-progress ë¼ë²¨ ì¶”ê°€ ë° ë‹´ë‹¹ì ì§€ì •
  handle-pr-opened:
    if: github.event_name == 'pull_request' && github.event.action == 'opened'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Extract issue numbers from PR body
        id: extract
        uses: ./.github/actions/extract-issue-numbers
        with:
          text: ${{ github.event.pull_request.body }}
          source-type: 'pr-body'
          validate-issues: true
          
      - name: Add in-progress label to linked issues
        if: steps.extract.outputs.issue-count > 0
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const prAuthor = context.payload.pull_request.user.login;
            const validIssues = '${{ steps.extract.outputs.valid-issues }}'.split(',').filter(n => n);

            for (const issueNumber of validIssues) {
              try {
                // ì´ìŠˆì— in-progress ë¼ë²¨ ì¶”ê°€
                await github.rest.issues.addLabels({
                  owner,
                  repo,
                  issue_number: issueNumber,
                  labels: ['in-progress']
                });
                
                // ì´ìŠˆì— PR ì‘ì„±ìë¥¼ ë‹´ë‹¹ìë¡œ ì§€ì •
                await github.rest.issues.addAssignees({
                  owner,
                  repo,
                  issue_number: issueNumber,
                  assignees: [prAuthor]
                });
                
                console.log(`Added in-progress label and assigned ${prAuthor} to issue #${issueNumber}`);
              } catch (error) {
                console.log(`Failed to update issue #${issueNumber}: ${error.message}`);
              }
            }
            
            if (validIssues.length === 0) {
              console.log('No valid linked issues found in PR body');
            }

  # ë¸Œëœì¹˜ ìƒì„± ì‹œ ê´€ë ¨ ì´ìŠˆì— ë¼ë²¨ ì¶”ê°€
  handle-branch-created:
    if: github.event_name == 'create' && github.event.ref_type == 'branch'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Extract issue numbers from branch name
        id: extract
        uses: ./.github/actions/extract-issue-numbers
        with:
          text: ${{ github.event.ref }}
          source-type: 'branch-name'
          validate-issues: true
          
      - name: Add in-progress label to related issues
        if: steps.extract.outputs.issue-count > 0
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const branchName = context.payload.ref;
            const branchAuthor = context.payload.sender.login;
            const validIssues = '${{ steps.extract.outputs.valid-issues }}'.split(',').filter(n => n);

            for (const issueNumber of validIssues) {
              try {
                // ì´ìŠˆì— in-progress ë¼ë²¨ ì¶”ê°€
                await github.rest.issues.addLabels({
                  owner,
                  repo,
                  issue_number: issueNumber,
                  labels: ['in-progress']
                });
                
                // ë¸Œëœì¹˜ ìƒì„±ìë¥¼ ë‹´ë‹¹ìë¡œ ì§€ì •
                await github.rest.issues.addAssignees({
                  owner,
                  repo,
                  issue_number: issueNumber,
                  assignees: [branchAuthor]
                });
                
                console.log(`Added in-progress label and assigned ${branchAuthor} to issue #${issueNumber} for branch ${branchName}`);
              } catch (error) {
                console.log(`Failed to update issue #${issueNumber}: ${error.message}`);
              }
            }
            
            if (validIssues.length === 0) {
              console.log(`No valid issue numbers found in branch name: ${branchName}`);
            }

  # PRì´ ë¨¸ì§€ë  ë•Œ ì—°ê²°ëœ ì´ìŠˆ ìë™ ë‹«ê¸°
  close-linked-issues:
    if: github.event.action == 'closed' && github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Extract issue numbers from PR
        id: extract-pr
        uses: ./.github/actions/extract-issue-numbers
        with:
          text: "${{ github.event.pull_request.body || '' }}"
          source-type: 'pr-body'
          validate-issues: true
          
      - name: Extract issue numbers from branch name
        id: extract-branch
        uses: ./.github/actions/extract-issue-numbers
        with:
          text: ${{ github.event.pull_request.head.ref }}
          source-type: 'branch-name'
          validate-issues: true
          
      - name: Close related issues
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const prNumber = context.payload.pull_request.number;
            const prTitle = context.payload.pull_request.title;
            
            const prIssues = '${{ steps.extract-pr.outputs.valid-issues }}'.split(',').filter(n => n);
            const branchIssues = '${{ steps.extract-branch.outputs.valid-issues }}'.split(',').filter(n => n);
            
            // ì¤‘ë³µ ì œê±°í•˜ì—¬ ëª¨ë“  ì´ìŠˆ ë²ˆí˜¸ í•©ì¹˜ê¸°
            const allIssues = [...new Set([...prIssues, ...branchIssues])];

            if (allIssues.length > 0) {
              for (const issueNumber of allIssues) {
                try {
                  await github.rest.issues.update({
                    owner,
                    repo,
                    issue_number: issueNumber,
                    state: 'closed'
                  });
                  
                  await github.rest.issues.createComment({
                    owner,
                    repo,
                    issue_number: issueNumber,
                    body: `ì´ ì´ìŠˆëŠ” PR #${prNumber} (${prTitle})ê°€ ë³‘í•©ë˜ì–´ ìë™ìœ¼ë¡œ ë‹«í˜”ìŠµë‹ˆë‹¤.`
                  });
                  
                  console.log(`Closed issue #${issueNumber} via PR #${prNumber}`);
                } catch (error) {
                  console.log(`Failed to close issue #${issueNumber}: ${error.message}`);
                }
              }
            } else {
              console.log(`No valid issue numbers found in PR #${prNumber}`);
            }

  # PRì´ ë‹¤ì‹œ ì—´ë¦´ ë•Œ ì´ìŠˆë„ ë‹¤ì‹œ ì—´ê¸°
  reopen-linked-issues:
    if: github.event_name == 'pull_request' && github.event.action == 'reopened'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Extract issue numbers from PR
        id: extract-pr
        uses: ./.github/actions/extract-issue-numbers
        with:
          text: "${{ github.event.pull_request.body || '' }}"
          source-type: 'pr-body'
          validate-issues: true
          
      - name: Reopen linked issues
        if: steps.extract-pr.outputs.issue-count > 0
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const prNumber = context.payload.pull_request.number;
            const validIssues = '${{ steps.extract-pr.outputs.valid-issues }}'.split(',').filter(n => n);

            for (const issueNumber of validIssues) {
              try {
                await github.rest.issues.update({
                  owner,
                  repo,
                  issue_number: issueNumber,
                  state: 'open'
                });
                
                // completed ë¼ë²¨ ì œê±°í•˜ê³  in-progress ë¼ë²¨ ì¶”ê°€
                try {
                  await github.rest.issues.removeLabel({
                    owner,
                    repo,
                    issue_number: issueNumber,
                    name: 'completed'
                  });
                } catch (error) {
                  console.log(`completed label not found on issue #${issueNumber}`);
                }
                
                await github.rest.issues.addLabels({
                  owner,
                  repo,
                  issue_number: issueNumber,
                  labels: ['in-progress']
                });
                
                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number: issueNumber,
                  body: `ğŸ”„ ì´ ì´ìŠˆëŠ” PR #${prNumber}ì´ ë‹¤ì‹œ ì—´ë ¤ì„œ ì¬ê°œë˜ì—ˆìŠµë‹ˆë‹¤.`
                });
                
                console.log(`Reopened issue #${issueNumber}`);
              } catch (error) {
                console.log(`Failed to reopen issue #${issueNumber}: ${error.message}`);
              }
            }
            
            if (validIssues.length === 0) {
              console.log(`No valid issue numbers found in PR #${prNumber}`);
            }
