name: Main Build

on:
  push:
    branches:
      - main
      - develop

jobs:
  build:
    name: Build and Deploy Check
    uses: ./.github/workflows/shared/build.yml
    with:
      node-version: '20.x' # 단일 Node 버전
      upload-artifacts: true
      artifact-name: 'build'
      artifact-retention-days: 7
      run-lint: true
      fail-fast: true

  notify:
    name: Notify Build Status
    runs-on: ubuntu-latest
    needs: build
    if: failure()

    steps:
      - name: Build failed notification
        run: |
          echo "❌ Build failed for branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Please check the build logs for details."

      - name: Create issue on build failure
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const branch = context.ref.replace('refs/heads/', '');
            const commit = context.sha.substring(0, 7);

            await github.rest.issues.create({
              owner,
              repo,
              title: `� Build Failed: ${branch} branch`,
              body: `**빌드 실패 알림**\n\n- **브랜치**: \`${branch}\`\n- **커밋**: \`${commit}\`\n- **실패 시각**: ${new Date().toISOString()}\n\n[빌드 로그 확인하기](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\n\n빌드 실패 원인을 확인하고 수정해주세요.`,
              labels: ['bug', 'build-failure']
            });

  success-notification:
    name: Build Success Notification
    runs-on: ubuntu-latest
    needs: build
    if: success()

    steps:
      - name: Build success summary
        run: |
          echo "## 🎉 Build Success!" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Artifact**: ${{ needs.build.outputs.artifact-name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ✅ Ready for deployment" >> $GITHUB_STEP_SUMMARY
