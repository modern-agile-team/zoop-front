name: Main Build

on:
  push:
    branches:
      - main
      - develop

jobs:
  build:
    name: Build and Deploy Check
    uses: ./.github/workflows/shared/build.yml
    with:
      node-version: '20.x' # ë‹¨ì¼ Node ë²„ì „
      upload-artifacts: true
      artifact-name: 'build'
      artifact-retention-days: 7
      run-lint: true
      fail-fast: true

  notify:
    name: Notify Build Status
    runs-on: ubuntu-latest
    needs: build
    if: failure()

    steps:
      - name: Build failed notification
        run: |
          echo "âŒ Build failed for branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Please check the build logs for details."

      - name: Create issue on build failure
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const branch = context.ref.replace('refs/heads/', '');
            const commit = context.sha.substring(0, 7);

            await github.rest.issues.create({
              owner,
              repo,
              title: `ï¿½ Build Failed: ${branch} branch`,
              body: `**ë¹Œë“œ ì‹¤íŒ¨ ì•Œë¦¼**\n\n- **ë¸Œëžœì¹˜**: \`${branch}\`\n- **ì»¤ë°‹**: \`${commit}\`\n- **ì‹¤íŒ¨ ì‹œê°**: ${new Date().toISOString()}\n\n[ë¹Œë“œ ë¡œê·¸ í™•ì¸í•˜ê¸°](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\n\në¹Œë“œ ì‹¤íŒ¨ ì›ì¸ì„ í™•ì¸í•˜ê³  ìˆ˜ì •í•´ì£¼ì„¸ìš”.`,
              labels: ['bug', 'build-failure']
            });

  success-notification:
    name: Build Success Notification
    runs-on: ubuntu-latest
    needs: build
    if: success()

    steps:
      - name: Build success summary
        run: |
          echo "## ðŸŽ‰ Build Success!" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Artifact**: ${{ needs.build.outputs.artifact-name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: âœ… Ready for deployment" >> $GITHUB_STEP_SUMMARY
